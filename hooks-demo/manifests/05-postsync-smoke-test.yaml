apiVersion: batch/v1
kind: Job
metadata:
  name: postsync-smoke-test
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-weight: "0"
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
      - name: smoke-test
        image: curlimages/curl
        command:
        - sh
        - -c
        - |
          echo "Running smoke tests..."
          
          # Test 1: Check API health
          echo "Test 1: API Health Check"
          for i in {1..10}; do
            if curl -f -s http://backend-api/ > /dev/null; then
              echo "✅ API is responding"
              break
            fi
            echo "Waiting for API... attempt $i/10"
            sleep 5
          done
          
          # Test 2: Check database connectivity
          echo "Test 2: Database connectivity check"
          # In real scenario, would call /health endpoint that checks DB
          
          echo "✅ All smoke tests passed!"
      restartPolicy: Never
  backoffLimit: 3
