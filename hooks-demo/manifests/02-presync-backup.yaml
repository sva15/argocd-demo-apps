apiVersion: batch/v1
kind: Job
metadata:
  name: presync-backup
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-weight: "-3"
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
      - name: backup
        image: postgres:14-alpine
        env:
        - name: PGPASSWORD
          value: apppass
        command:
        - sh
        - -c
        - |
          echo "Starting database backup..."
          BACKUP_FILE="/tmp/backup-$(date +%Y%m%d-%H%M%S).sql"
          
          # Create backup
          pg_dump -h postgres -U appuser -d appdb > $BACKUP_FILE 2>/dev/null || {
            echo "Database doesn't exist yet or is empty, skipping backup"
            exit 0
          }
          
          echo "âœ… Backup completed: $BACKUP_FILE"
          ls -lh /tmp/backup-*.sql 2>/dev/null || echo "No backups found"
      restartPolicy: Never
  backoffLimit: 2
